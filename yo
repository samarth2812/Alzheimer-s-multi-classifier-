export const getIndentAuditTrail = async (
  user: User,
  indentId?: string,
  page: number = 1,
  pageSize: number = 10,
  filters?: {
    userRole?: string;
    actionType?: string;
  }
) => {
  try {
    if (
      user.role !== "COMPLIANCE_MAKER" &&
      user.role !== "COMPLIANCE_CHECKER"
    ) {
      throw new Error("You are not authorized to view audit trails.");
    }

    const where: any = {};

    if (indentId) {
      where.indentId = indentId;
    }

    if (filters?.userRole?.trim()) {
      where.role = filters.userRole.trim();
    }

    if (filters?.actionType?.trim()) {
      where.actionType = filters.actionType.trim();
    }

    const offset = (page - 1) * pageSize;

    const [auditEntries, total] = await Promise.all([
      prisma.indentAuditTrail.findMany({
        where,
        skip: offset,
        take: pageSize,
        orderBy: { timestamp: "desc" },
        select: {
          indentId: true,
          actionType: true,
          role: true,
          performedByName: true,
          performedByEmail: true,
          timestamp: true,
          modifications: true,
        },
      }),
      prisma.indentAuditTrail.count({ where }),
    ]);

    return {
      success: true,
      data: auditEntries,
      pagination: {
        total,
        page,
        pageSize,
        totalPages: Math.ceil(total / pageSize),
      },
    };
  } catch (error) {
    console.error("Failed to fetch audit trail", error);
    throw new Error("Unable to fetch audit trail");
  }
};
