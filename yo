export const addObligationRemark = async (
  req: customRequest,
  res: Response,
  next: NextFunction
): Promise<void> => {
  try {
    const user = req.user!;
    const { obligationId } = req.params;
    const remarkData = req.body;

    if (!obligationId) {
      throw ApiError.badRequest("Obligation ID is required");
    }

    if (!remarkData.content) {
      throw ApiError.badRequest("Remark content is required");
    }

    // FIXED: Convert database enum to UI string format for ROLE_MAPPING
    const uiRoleFormat = mapEnumToUIRole(user.role);

    // Validate and set user info with correct role format
    const completeRemarkData = {
      ...remarkData,
      author: remarkData.author || uiRoleFormat, // FIXED: Use UI format
      userId: remarkData.userId || user.id.toString(),
      timestamp: remarkData.timestamp || new Date().toISOString()
    };

   

    await createObligationRemark(obligationId, completeRemarkData);
    
    res.status(201).json({
      success: true,
      message: "Obligation remark added successfully"
    });
  } catch (error: any) {
    next(error);
  }
};
