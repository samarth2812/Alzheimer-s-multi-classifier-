import React, { useEffect, useState } from "react";
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Button,
  Box,
  InputAdornment,
  Stack,
  Avatar,
  IconButton,
} from "@mui/material";
import { CustomTextField } from "layouts/resuableComponents/customTextField";
import { SearchableDropdown } from "layouts/resuableComponents/searchableDropdown";
import { formSchema } from "./formSchema";
import { z } from "zod";
import toast from "react-hot-toast";
import { apiRequest } from "../../axios/apiRequest";
import { ArrowBackIosNew, CalendarToday, ReplyAll } from "@mui/icons-material";
import { dialogStyle } from "layouts/resuableComponents/styles";

import { dialogButtonStyle } from "layouts/resuableComponents/styles";
import { CustomSmartPasteField } from "layouts/resuableComponents/customSmartPasteField";
import { dialogButtonStyleTwo } from "layouts/resuableComponents/styles";
import { CustomSelectDropdown } from "layouts/resuableComponents/customSelectDropdown";
import { DynamicEmailInput } from "layouts/resuableComponents/dynamicEmailInput";
import { useSelector } from "react-redux";

export const commTypeLabels = [
  { name: "Inward", value: "INWARD" },
  { name: "Outward", value: "OUTWARD" },
];
export const categoryLabels = [
  { name: "Incident Report", value: "INCIDENT_REPORT" },
  { name: "Indent", value: "INDENT" },
  { name: "Obligation", value: "OBLIGATION" },
  { name: "Penalty Notice", value: "PENALTY_NOTICE" },
  { name: "Advisory", value: "ADVISORY" },
  { name: "ISE Observation", value: "ISE_OBSERVATION" },
  { name: "General Query", value: "GENERAL_QUERY" },
  { name: "Acknowledgement", value: "ACKNOWLDGEMENT" },
  { name: "Clarifictaion", value: "CLARIFICATION" },
];
export const priorityLabels = [
  { name: "High", value: "HIGH" },
  { name: "Low", value: "LOW" },
  { name: "Medium", value: "MEDIUM" },
];

const formatDatetimeLocal = (isoString) => {
  if (!isoString) return "";
  const date = new Date(isoString);
  const tzOffset = date.getTimezoneOffset() * 60000;
  const localISO = new Date(date.getTime() - tzOffset).toISOString().slice(0, 16);
  return localISO;
};
const addCommunicationRecordUrl = `${process.env.REACT_APP_BACKEND_URL}/api/v1/communication/`;

function stringAvatar(name) {
  return {
    sx: {
      bgcolor: (theme) => theme.palette.custom.background1,
    },
    children: `${name.split(" ")[0][0]}${name.split(" ")[1]?.[0] || ""}`,
  };
}

export default function CommunicationFormDialog({ open, onClose, onSubmit, initialData, user }) {
  const [formData, setFormData] = useState({
    commId: "",
    commType: "",
    category: "",
    refNo: "",
    sentBy: user.email,
    sentTo: [],
    cc: [],
    subject: "",
    responseDueBy: "",
    priorityLevel: "",
    summary: "",
    status: "Sent",
  });

  const [errors, setErrors] = useState({});
  const [isSubmitting, setIsSubmitting] = useState(false);

  useEffect(() => {
    if (initialData) {
      setFormData({
        ...initialData,
        responseDueBy: initialData?.responseDueBy
          ? formatDatetimeLocal(initialData?.responseDueBy)
          : "",
        commType: commTypeLabels.find((s) => s.value === initialData.commType)?.name || "",
        category: categoryLabels.find((s) => s.value === initialData.category)?.name || "",
      });
    } else {
      setFormData({
        commType: "",
        category: "",
        refNo: "",
        sentBy: user.email,
        sentTo: [],
        cc: [],
        subject: "",
        responseDueBy: "",
        priorityLevel: "",
        summary: "",
        status: "Sent",
      });
    }
  }, [initialData]);

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData((prev) => ({ ...prev, [name]: value }));

    if (errors[name]) {
      setErrors({
        ...errors,
        [name]: undefined,
      });
    }
  };
  const handleValidationError = (error) => {
    if (error instanceof z.ZodError) {
      const formattedErrors = {};
      error.errors.forEach((err) => {
        const path = err.path[0];
        formattedErrors[path] = err.message;
      });
      setErrors(formattedErrors);
    } else {
      toast.error("An error occurred while submitting the form.");
    }
  };

  const handleAddCommunicationRecord = async () => {
    try {
      let result;
      setIsSubmitting(true);
      const validatedData = formSchema.parse(formData);
      result = await apiRequest("POST", addCommunicationRecordUrl, validatedData);
      if (result.status === 201 || result.status === 204) {
        toast.success("Communication Added Successfully");
      }
      onSubmit();
      onClose();
    } catch (error) {
      handleValidationError(error);
    } finally {
      setIsSubmitting(false);
    }
  };
  const handleDescriptionChange = (htmlContent) => {
    setFormData((prev) => ({ ...prev, summary: htmlContent }));
  };

  const handleUpdateCommunicationRecord = async () => {
    try {
      setIsSubmitting(true);
      let updatedFields = {};
      const updatableFields = [
        "category",
        "refNo",
        "sentBy",
        "sentTo",
        "cc",
        "subject",
        "responseDueBy",
        "status",
        "priorityLevel",
        "summary",
        "commType",
      ];

      updatableFields.forEach((field) => {
        let newValue = formData[field];
        let initialValue = initialData[field];

        if (field === "responseDueBy") {
          newValue = new Date(formData[field]).toISOString();
          initialValue = new Date(initialData[field]).toISOString();
        }

        if (field === "priorityLevel") {
          newValue = priorityLabels.find((item) => item.name === newValue)?.value || newValue;
        }

        if (field === "commType") {
          newValue = commTypeLabels.find((item) => item.name === newValue)?.value || newValue;
        }

        if (field === "category") {
          newValue = categoryLabels.find((item) => item.name === newValue)?.value || newValue;
        }

        if (newValue !== initialValue) {
          updatedFields[field] = formData[field];
        }
      });

      if (Object.keys(updatedFields).length > 0) {
        updatedFields = { ...updatedFields, updateType: "FIELD_UPDATE" };
        const payload = {
          updatedFields,
        };
        const result = await apiRequest(
          "PUT",
          `${process.env.REACT_APP_BACKEND_URL}/api/v1/communication/${user.role}/${user.department}/${formData.commId}`,
          payload
        );

        if (result.status === 200 || result.status === 204) {
          toast.success("communication updated successfully!");
        }
      } else {
        toast.error("Looks like you haven't made any changes yet!");
      }
      onSubmit();
      onClose();
    } catch (error) {
      handleValidationError(error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSubmit = async () => {
    if (initialData) {
      handleUpdateCommunicationRecord();
    } else {
      handleAddCommunicationRecord();
    }
  };

  return (
    <Dialog open={open} onClose={onClose} fullWidth maxWidth="md" sx={dialogStyle}>
      <DialogTitle sx={{ p: 0, pb: 2 }}>
        <Box display="flex" alignItems="center" justifyContent="space-between" px={2} pt={2}>
          <Stack direction="row" spacing={1.5} alignItems="center">
            <IconButton
              onClick={onClose}
              size="small"
              sx={{ color: (theme) => theme.palette.custom.text2 }}
            >
              <ArrowBackIosNew />
            </IconButton>
            <Avatar {...stringAvatar(user?.name || "User")} sx={{ width: 36, height: 36 }} />
            <Box display="flex" flexDirection="column">
              <Box
                sx={{
                  fontSize: "0.85rem",
                  fontWeight: 500,
                  color: (theme) => theme.palette.custom.two,
                }}
              >
                {user?.name}
              </Box>
              <Box sx={{ fontSize: "0.7rem", color: (theme) => theme.palette.custom.text2 }}>
                {user?.email}
              </Box>
            </Box>
          </Stack>
          <Stack direction="row" spacing={2} alignItems="center">
            <CustomSelectDropdown
              placeholder="Priority Level"
              name="priorityLevel"
              value={formData.priorityLevel}
              onChange={handleChange}
              options={priorityLabels}
              sx={{ minWidth: 100, width: "100%" }}
            />
            <CustomSelectDropdown
              name="commType"
              value={formData.commType}
              onChange={handleChange}
              options={commTypeLabels}
              placeholder="Type"
              sx={{ minWidth: 100, width: "100%" }}
            />
          </Stack>
        </Box>
      </DialogTitle>
      <DialogContent>
        <Box display="flex" flexDirection="column" gap={3} mt={2}>
          <Box display="flex" gap={2}>
            <SearchableDropdown
              label="Category"
              placeholder="Enter Category"
              name="category"
              options={categoryLabels}
              value={formData.category}
              onChange={handleChange}
              error={errors.category}
            />
            <CustomTextField
              label="Reference Number"
              name="refNo"
              placeholder="Enter Reference Number"
              value={formData.refNo}
              onChange={handleChange}
              error={errors.refNo}
            />
          </Box>
          <DynamicEmailInput
            label="Sent To"
            name="sentTo"
            placeholder="Receiver Email Address"
            value={formData.sentTo}
            onChange={(val) => setFormData((prev) => ({ ...prev, sentTo: val }))}
            error={errors.sentTo}
            chipbgColor={(theme) => theme.palette.custom.one}
            chipTxtColor={(theme) => theme.palette.custom.text2}
          />
          <DynamicEmailInput
            label="CC"
            name="cc"
            placeholder="Add CC recipients"
            value={formData.cc}
            onChange={(val) => setFormData((prev) => ({ ...prev, cc: val }))}
            error={errors.cc}
            chipbgColor={(theme) => theme.palette.custom.two}
            chipTxtColor={(theme) => theme.palette.custom.light}
          />
          <CustomTextField
            label="Subject"
            name="subject"
            placeholder="Enter Subject of the Email"
            value={formData.subject}
            onChange={handleChange}
            error={errors.subject}
          />
          <Box display="flex" gap={2}>
            <CustomTextField
              label="Response Due By"
              name="responseDueBy"
              placeholder="Enter Due Date"
              type="datetime-local"
              value={formData.responseDueBy}
              onChange={handleChange}
              error={errors.responseDueBy}
              endAdornment={
                <InputAdornment position="end">
                  <CalendarToday
                    sx={{ color: (theme) => theme.palette.custom.two, fontSize: "1.2rem" }}
                  />
                </InputAdornment>
              }
            />
          </Box>
          <CustomSmartPasteField
            value={formData.summary}
            label="Summary"
            placeholder="enter summary"
            onChange={handleDescriptionChange}
            error={errors.summary}
          />
        </Box>
      </DialogContent>
      <DialogActions>
        <Button size="small" sx={dialogButtonStyleTwo}>
          Save as Draft
        </Button>
        <Button onClick={handleSubmit} disabled={isSubmitting} sx={dialogButtonStyle} size="small">
          {initialData ? "Update" : "Sent"}
        </Button>
      </DialogActions>
    </Dialog>
  );
}
