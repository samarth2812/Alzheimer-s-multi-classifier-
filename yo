export interface customRequest extends Request {
  user?: User | JwtPayload; // User from Prisma or JWT payload
}

import { NextFunction } from "express";
import { customRequest } from "../../types/customDefiniton";
import { ApiError } from "../../utils/ApiError";
import { EmailType, triggerManualReminderEmails } from "../../services/email/manualEmailReminderService";
import { User } from "@prisma/client";


export const sendManualReminderEmail = async (
  req: customRequest,
  res: Response,
  next: NextFunction
): Promise<void> => {
  try {
    const user = req.user!;
    const { emailType } = req.params;
    const { emailData, assignees } = req.body;

    if (!emailType || !["OBLIGATION", "INDENT", "INCIDENT", "OBSERVATION"].includes(emailType)) {
      throw ApiError.badRequest("Valid emailType is required");
    }

    if (!emailData || typeof emailData !== "object") {
      throw ApiError.badRequest("Valid emailData is required");
    }

    if (!Array.isArray(assignees) || assignees.length === 0) {
      throw ApiError.badRequest("At least one assignee is required");
    }

    await triggerManualReminderEmails(
      emailType as EmailType,
      user as User,
      emailData,
      assignees
    );

    res.status(200).json({
      success: true,
      message: "Reminder email(s) triggered successfully",
    });
  } catch (error) {
    next(error);
  }
};
