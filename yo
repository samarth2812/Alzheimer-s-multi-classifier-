export const exportIndentsExcel = async (
  req: customRequest,
  res: Response,
  next: NextFunction
): Promise<void> => {
  try {
    const user = req.user!;
    const {
      status,
      priorityLevel,
      department,
      category,
      search,
      startDate,
      endDate,
    } = req.query;

    const filters = {
      status: status as "open" | "Closed",
      priorityLevel: priorityLevel as IndentPriority,
      department: department as Department,
      category: category as IndentCategory,
      search: search as string,
      startDate: startDate as string,
      endDate: endDate as string,
    };

    const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `indents_${timestamp}.xlsx`;

    res.setHeader(
      "Content-Type",
      "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    );
    res.setHeader("Content-Disposition", `attachment; filename="${filename}"`);

    await generateIndentExcel(res, user.role, user.department, filters);
  } catch (error: any) {
    console.error("Error exporting indents Excel:", error);

    if (!res.headersSent) {
      res.status(500).json({
        success: false,
        message: `Failed to generate Excel export: ${
          error instanceof Error ? error.message : "Unknown error"
        }`,
      });
    } else {
      res.end();
    }
  }
};
